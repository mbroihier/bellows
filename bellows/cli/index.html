<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script>
      window.onload = function(){
	  var socket = null;
	  var wsexists = false;
	  var initialMessage;
	  var statusObject = {"34:10:f4:ff:fe:2f:3f:b6" : true, "b0:c7:de:ff:fe:52:ca:58" : true};
	  let start = function(message) {
	      initialMessage = message;
	      socket = new WebSocket("ws://192.168.1.224:8126");
	      
	      socket.onopen = function(e) {
		  console.log("ws connection made");
		  socket.send(initialMessage);
		  for (device in statusObject) {
		      let message = device + 'status';
		      console.log("sending: " + message);
		      socket.send(message);
		  }
		  wsexists = true;
	      };
	      socket.onmessage = function(event) {
		  statusObject = JSON.parse(event.data);
		  console.log(statusObject)
		  for (device in statusObject) {
		      console.log("working with " + device);
		      if (statusObject[device] == 'on') {
			  console.log("device is " + statusObject[device])
			  document.getElementById(device+'off').setAttribute('style', 'visibility: visible');
			  document.getElementById(device+'on').setAttribute('style', 'visibility: hidden');
		      } else if (statusObject[device] == 'off') {
			  console.log("device is " + statusObject[device])
			  document.getElementById(device+'on').setAttribute('style', 'visibility: visible');
			  document.getElementById(device+'off').setAttribute('style', 'visibility: hidden');
		      } else if (statusObject[device] == 'unknown') {
			  console.log("device is " + statusObject[device])
			  document.getElementById(device+'on').setAttribute('style', 'visibility: visible');
			  document.getElementById(device+'off').setAttribute('style', 'visibility: visible');
		      } else {
			  document.getElementById(device+'on').setAttribute('style', 'visibility: visible');
			  document.getElementById(device+'off').setAttribute('style', 'visibility: visible');
		      }
		  }
	      }
	      socket.onclose = function(e) {
		  console.log("didn't expect close");
		  if (!wsexists) {
		      for (device in statusObject) {
			  console.log("setting up for no websocket server " + device);
			  document.getElementById(device+'off').setAttribute('style', 'visibility: visible');
			  document.getElementById(device+'off').setAttribute('type', 'submit');
			  document.getElementById(device+'off').setAttribute('formaction', '/'+device+'off');
			  document.getElementById(device+'off').setAttribute('formmethod', 'get');
			  document.getElementById(device+'on').setAttribute('style', 'visibility: visible');
			  document.getElementById(device+'on').setAttribute('type', 'submit');
			  document.getElementById(device+'on').setAttribute('formaction', '/'+device+'on');
			  document.getElementById(device+'on').setAttribute('formmethod', 'get');
		      }
		  } else {
		      socket = null;
		  }
	      }
	  }
	  start("initial startup");
	  wssend = function(message) {
	      if (wsexists) {
		  try {
		      console.log("sending " + message);
		      socket.send(message);
		  } catch (error) {
		      console.log("websocket send failed: " + error);
		      start(message);
		  }
	      }
	  }
      }
      </script>
    <title> Light Controller </title>
  </head>
  <body>
    <style>
      div {
	  width: 100%;
	  height: 300px;
	  text-align: center;
      }
      ul {
	  list-style-type: none;
      }
      button {
	  width: 35%;
	  padding: 4px 4px;
	  border: 3px solid black;
	  margin: 2px 2px;
	  font-size: 50px;
	  border-radius: 10px;
      }
    </style>
    <h1> Switches </h1>
    <ul>
      <div>
      <form>
      <li><button id="34:10:f4:ff:fe:2f:3f:b6on" style="visibility: hidden" onclick="wssend('34:10:f4:ff:fe:2f:3f:b6on')" >bedroom on</button></li>
      <li><button id="34:10:f4:ff:fe:2f:3f:b6off" style="visibility: hidden" onclick="wssend('34:10:f4:ff:fe:2f:3f:b6off')">bedroom off</button></li>
      <li><button id="b0:c7:de:ff:fe:52:ca:58on" style="visibility: hidden" onclick="wssend('b0:c7:de:ff:fe:52:ca:58on')" >office on </button></li>
      <li><button id="b0:c7:de:ff:fe:52:ca:58off" style="visibility: hidden" onclick="wssend('b0:c7:de:ff:fe:52:ca:58off')"> office off </button></li>
      </form>
      </div>
    </ul>
  </body>
</html>
